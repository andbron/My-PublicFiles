Describe "Pipeline YAML" {

    BeforeAll {
        Install-YamlModule
    }

    Context "multiStage.yml" -Tag "config","template" {

        BeforeAll {
            if (Test-Path "pipeline/Release/multiStage.yml") {
                $yml = get-content "pipeline/Release/multiStage.yml" | ConvertFrom-Yaml
            }
            if ((Get-Location) -match "code[\\/]templates") {
                $ymlPath = Join-Path ((Get-Location) -split ("code[\\/]templates"))[0] "code\templates\pipeline\default\Release\multiStage.yml"
                $yml = get-content $ymlPath | ConvertFrom-Yaml
            }
            $control = $yml.resources.repositories | Where-Object {$_.repository -eq "control"}
        }

        It "repositories in resources block must include 'control'" {
            $yml.resources.repositories.repository.Contains("control") | Should -Be $true
        }

        It "control needs to reference 'ec.platform/ec.control'" {
            $control.name | Should -Be "ec.platform/ec.control"
        }

        It "there can only be one stage" {
            $yml.stages.Count | Should -Be 1
        }

        It "stage template must be 'code/pipeline/AzureDevOps/ecpMultiStage.yml@control'" {
            $yml.stages[0].template | Should -Be "code/pipeline/AzureDevOps/ecpMultiStage.yml@control"
        }

    }

}